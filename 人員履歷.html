<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>茁思科技 - 履歷管理系統 (雲端版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .font-serif {
            font-family: 'Noto Serif TC', serif;
        }

        .bg-cornflower-blue {
            background-color: #6495ED !important; /* 強制覆蓋 */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* 自定義淡入動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* 列印樣式設定 */
        @media print {
            @page {
                margin: 0;
                size: A4;
            }
            body {
                background: white;
                padding: 0;
            }
            /* 隱藏非列印元素 */
            .no-print, nav, button, .tabs-nav, #cloud-status, #preview-warning {
                display: none !important;
            }
            /* 確保背景顏色被列印 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* 調整預覽區塊為全頁 */
            #preview-section, #preview-content-container {
                display: block !important;
                padding: 0;
                margin: 0;
                width: 100%;
                box-shadow: none;
            }
            .print-container {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 10mm !important; /* 模擬 A4 邊距 */
                border: none !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 pb-10 min-h-screen">

    <!-- 頂部導航列 -->
    <nav class="bg-white shadow-md sticky top-0 z-50 tabs-nav">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center h-auto md:h-16 py-2 md:py-0 gap-3 md:gap-0">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i data-lucide="cloud" width="24" height="24"></i>
                    </div>
                    <div>
                        <span class="font-bold text-xl text-gray-800">履歷管理系統</span>
                        <span id="cloud-status" class="text-xs ml-2 px-2 py-0.5 rounded-full bg-gray-200 text-gray-500 animate-pulse">連線中...</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="switchTab('edit')" id="btn-edit" class="px-4 py-2 rounded-md flex items-center gap-2 transition-colors bg-blue-100 text-blue-700 font-medium">
                        <i data-lucide="user" width="18"></i> 編輯資料
                    </button>
                    <button onclick="switchTab('projects')" id="btn-projects" class="px-4 py-2 rounded-md flex items-center gap-2 transition-colors hover:bg-gray-100 text-gray-600">
                        <i data-lucide="layout-list" width="18"></i> 專案總表管理
                    </button>
                    <button onclick="switchTab('preview')" id="btn-preview" class="px-4 py-2 rounded-md flex items-center gap-2 transition-colors hover:bg-gray-100 text-gray-600">
                        <i data-lucide="file-text" width="18"></i> 預覽與列印
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto mt-6 px-4">
        
        <!-- 分頁 1: 編輯員工資料 -->
        <div id="edit-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
            <!-- 左側：基本資料表單 -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 人員快速選擇區 -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100 shadow-sm flex flex-col md:flex-row items-start md:items-center gap-4">
                    <div class="flex items-center gap-2 text-blue-800 font-bold whitespace-nowrap">
                        <i data-lucide="users" width="20"></i>
                        <span>快速載入人員：</span>
                    </div>
                    <select id="employee-select" onchange="switchEmployee(this.value)" class="flex-1 w-full px-4 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white shadow-sm cursor-pointer hover:border-blue-400 transition-colors">
                        <option value="">-- 資料載入中 --</option>
                        <!-- JS 動態生成人員選項 -->
                    </select>
                </div>

                <!-- 基本資料 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative">
                    <!-- 儲存指示器 -->
                    <div id="save-indicator" class="absolute top-4 right-4 text-xs font-bold text-green-600 opacity-0 transition-opacity flex items-center gap-1">
                        <i data-lucide="check" width="12"></i> 已儲存
                    </div>

                    <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex items-center gap-2">
                        <i data-lucide="user" class="text-blue-600" width="20"></i>
                        <h2 class="font-semibold text-blue-900">基本資料編輯</h2>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 履歷表頭職稱 -->
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-medium text-gray-700 flex items-center gap-1">
                                <span class="bg-blue-600 text-white text-xs px-1.5 rounded">表頭</span>
                                履歷職稱 (藍色底標題)
                            </label>
                            <select id="input-defaultTitle" onchange="updateCurrentEmployee('defaultTitle', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white font-medium text-blue-900">
                                <option value="">-- 請選擇職稱 --</option>
                                <!-- JS Populated -->
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">姓名</label>
                            <input type="text" id="input-name" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">性別</label>
                            <input type="text" id="input-gender" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed">
                        </div>
                        <!-- 現職可編輯 -->
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-medium text-gray-700">現職 (表格內)</label>
                            <input type="text" id="input-currentJob" oninput="debounceUpdate('currentJob', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        </div>
                    </div>
                </div>

                <!-- 學經歷 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex items-center gap-2">
                        <i data-lucide="graduation-cap" class="text-blue-600" width="20"></i>
                        <h2 class="font-semibold text-blue-900">學歷與經歷</h2>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">學校名稱</label>
                            <input type="text" id="input-school" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">系所</label>
                            <input type="text" id="input-department" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">學位</label>
                            <input type="text" id="input-degree" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed">
                        </div>
                        <div class="md:col-span-3 space-y-2">
                            <label class="text-sm font-medium text-gray-700">經歷</label>
                            <textarea id="input-experience" rows="4" readonly class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed font-sans"></textarea>
                        </div>
                        <div class="md:col-span-3 space-y-2">
                            <label class="text-sm font-medium text-gray-700 flex justify-between items-center">
                                <span>專長</span>
                                <span class="text-xs text-blue-600 font-normal">* 可從下拉選單選擇或手動修改 (自動儲存)</span>
                            </label>
                             <select id="skills-select" onchange="updateSkillsFromSelect(this.value)" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                                <option value="">-- 請選擇專長組合 --</option>
                                <!-- JS Populated -->
                            </select>
                            <textarea id="input-skills" rows="3" oninput="debounceUpdate('skills', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400" placeholder="選擇上方專長後，內容會出現在此，亦可手動編輯"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：專案勾選區 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col sticky top-24" style="max-height: calc(100vh - 120px);">
                    <div class="bg-green-50 px-6 py-4 border-b border-green-100 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="check-square" class="text-green-600" width="20"></i>
                            <h2 class="font-semibold text-green-900">勾選參與專案</h2>
                        </div>
                        <!-- 全選按鈕 -->
                        <button onclick="toggleSelectAll()" class="flex items-center gap-1 text-xs bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1.5 rounded transition-colors font-medium">
                            <i data-lucide="list-checks" width="14"></i>
                            全選 / 取消
                        </button>
                    </div>
                    <div id="project-selection-list" class="p-4 flex-1 overflow-y-auto space-y-2">
                        <div class="text-center text-gray-400 text-sm mt-4">資料載入中...</div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200 text-xs text-gray-500 text-center">
                        已選擇 <span id="selected-count">0</span> 個專案
                    </div>
                </div>
            </div>
        </div>

        <!-- 分頁 2: 專案總表管理 -->
        <div id="projects-section" class="space-y-6 animate-fade-in hidden">
            <!-- 新增專案區塊 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex items-center gap-2">
                    <i data-lucide="plus" class="text-indigo-600" width="20"></i>
                    <h2 class="font-semibold text-indigo-900">新增系統專案</h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2 space-y-1">
                        <label class="text-xs font-medium text-gray-500">專案名稱</label>
                        <input type="text" id="new-project-name" placeholder="例如：114年度..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-medium text-gray-500">客戶</label>
                        <input type="text" id="new-project-client" placeholder="例如：環境部" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-medium text-gray-500">結案日期</label>
                        <input type="text" id="new-project-date" placeholder="例如：2025/12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <button onclick="addNewProject()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors h-[42px]">
                        <i data-lucide="plus" width="18"></i> 新增至資料庫
                    </button>
                </div>
            </div>

            <!-- 現有專案列表 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center gap-2">
                    <i data-lucide="layout-list" class="text-gray-600" width="20"></i>
                    <h2 class="font-semibold text-gray-900">現有專案列表 (<span id="total-projects-count">0</span>)</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 border-b">
                            <tr>
                                <th class="px-6 py-3 font-medium">專案名稱</th>
                                <th class="px-6 py-3 font-medium w-48">客戶</th>
                                <th class="px-6 py-3 font-medium w-32">結案日期</th>
                                <th class="px-6 py-3 font-medium w-24 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="master-project-list" class="divide-y divide-gray-100">
                           <tr><td colspan="4" class="p-4 text-center text-gray-400">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 分頁 3: 預覽與列印 -->
        <div id="preview-section" class="flex flex-col items-center animate-fade-in hidden">
            <!-- 警告訊息容器 -->
            <div id="preview-warning" class="hidden text-center py-10 text-gray-500 w-full">
                請先在「編輯資料」分頁選擇一位人員
            </div>

            <!-- 內容容器 -->
            <div id="preview-content-container" class="w-full flex flex-col items-center">
                <div class="w-full max-w-4xl mb-6 flex justify-between items-center no-print">
                    <p class="text-gray-500 text-sm">
                        * 此頁面模擬 A4 列印效果，請點擊右側按鈕進行列印或儲存 PDF。
                    </p>
                    <div class="flex gap-2">
                        <button onclick="downloadWord()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow-sm flex items-center gap-2 transition-colors font-medium">
                            <i data-lucide="file-down" width="18"></i> 下載 Word
                        </button>
                        <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-sm flex items-center gap-2 transition-colors font-medium">
                            <i data-lucide="printer" width="18"></i> 列印 / 另存 PDF
                        </button>
                    </div>
                </div>

                <!-- 履歷表格 (Preview) -->
                <div class="print-container bg-white p-8 shadow-lg w-full max-w-[210mm] min-h-[297mm] mx-auto overflow-hidden">
                    <div class="border-2 border-black">
                        
                        <!-- Header -->
                        <div class="bg-cornflower-blue text-black font-serif px-2 py-1 border-b border-black text-lg">
                            <span id="preview-headerTitle"></span>
                        </div>

                        <!-- Name & Gender -->
                        <div class="flex border-b border-black">
                            <div class="w-1/2 p-2 border-r border-black font-serif text-lg">
                                姓名：<span id="preview-name"></span>
                            </div>
                            <div class="w-1/2 p-2 font-serif text-lg">
                                性別：<span id="preview-gender"></span>
                            </div>
                        </div>

                        <!-- Current Job -->
                        <div class="p-2 border-b border-black font-serif text-lg">
                            現職：<span id="preview-currentJob"></span>
                        </div>

                        <!-- Education Header -->
                        <div class="bg-cornflower-blue text-black px-2 py-1 border-b border-black text-lg font-serif">
                            最高學歷
                        </div>

                        <!-- Education Columns -->
                        <div class="flex border-b border-black bg-cornflower-blue text-black">
                            <div class="w-1/3 px-2 py-1 border-r border-black font-serif">學校名稱</div>
                            <div class="w-1/3 px-2 py-1 border-r border-black font-serif">系所</div>
                            <div class="w-1/3 px-2 py-1 font-serif">學位</div>
                        </div>

                        <!-- Education Content -->
                        <div class="flex border-b border-black h-12 items-center">
                            <div class="w-1/3 px-2 border-r border-black font-serif text-lg" id="preview-school"></div>
                            <div class="w-1/3 px-2 border-r border-black font-serif text-lg" id="preview-department"></div>
                            <div class="w-1/3 px-2 font-serif text-lg" id="preview-degree"></div>
                        </div>

                        <!-- Experience Header -->
                        <div class="bg-cornflower-blue text-black px-2 py-1 border-b border-black text-lg font-serif">
                            經歷
                        </div>

                        <!-- Experience Content -->
                        <div class="p-4 border-b border-black font-serif text-lg whitespace-pre-wrap leading-relaxed min-h-[100px]" id="preview-experience">
                        </div>

                        <!-- Skills Header -->
                        <div class="bg-cornflower-blue text-black px-2 py-1 border-b border-black text-lg font-serif">
                            專長
                        </div>

                        <!-- Skills Content -->
                        <div class="p-4 border-b border-black font-serif text-lg" id="preview-skills">
                        </div>

                        <!-- Project Table Header -->
                        <div class="flex bg-cornflower-blue text-black border-b border-black">
                            <div class="w-[60%] px-2 py-1 border-r border-black font-serif text-lg">參與專案活動名稱</div>
                            <div class="w-[25%] px-2 py-1 border-r border-black font-serif text-lg">客戶</div>
                            <div class="w-[15%] px-2 py-1 font-serif text-lg">結案日期</div>
                        </div>

                        <!-- Project Rows (Dynamic) -->
                        <div id="preview-project-list">
                            <!-- JS renders projects here -->
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Initial Data for Database Seeding (Static) -->
    <script>
        // Make these available globally for seeding
        window.INITIAL_EMPLOYEES_DATA = [
            { id: 'p1', name: '陳慶宇', gender: '男', currentJob: '茁思科技業務組長', school: '國立勤益科技大學', department: '企業管理系', degree: '學士', experience: '茁思科技股份有限公司業務專員、計畫經理（2023-迄今）\n欣宸幼兒運動工作室體能高中職教育工作者（2020-2022）', defaultTitle: '客戶服務組長', skills: '專案管理、規劃執行、專案活動執行、Excel、PowerPoint、Word', selectedProjectIds: [1, 2] },
            { id: 'p2', name: '林怡君', gender: '女', currentJob: '茁思科技業務協理', school: '國立臺北大學', department: '企業管理學系', degree: '碩士', experience: '茁思科技業務協理(2018-迄今)\n茁思科技股份有限公司 計畫經理(2016-2018)\n馬來西亞商思想科技有限公司臺灣分公司 業務經理(2013-2016)\n玉山銀行顧客服務專員(2012-2013)\n麗庭莊園婚宴企劃(2010-2012)\nGoogle 企業解決方案講師', defaultTitle: '計畫主持人', skills: '計畫管理、Social Analytics、輿情分析與應用、Google Maps Business View、Google Apps for Work、Google Place、G Sutie、Visio、Excel、PowerPoint、Word、Page、Adobe', selectedProjectIds: [] },
            { id: 'p3', name: '曾煥忠', gender: '男', currentJob: '茁思科技股份有限公司總經理', school: '文化大學', department: '企業管理學系', degree: '學士', experience: '茁思科技股份有限公司總經理(2016-迄今)\n馬來西亞商思想科技有限公司台灣分公司總經理(2013-2016)\n群立科技股份有限公司臺北公司總經理(2006-2013)\n群立科技股份有限公司臺北公司業務部經理(2004-2006)\n仲琦科技股份有限公司業務經理(2003-2004)', defaultTitle: '協同計畫主持人', skills: '團隊組織與管理 Team Building & Mentoring、客戶關係管理 Client Relations Management、簡報技巧 Presentations、地理資訊系統、專案管理、Social Analytics、輿情分析與應用、Google Maps for Work、ESRI ArcGIS、Google Apps for Work、Google Search Engine', selectedProjectIds: [] },
            { id: 'p4', name: '陳芷瑩', gender: '女', currentJob: '茁思科技專案經理', school: '臺灣師範大學', department: '圖文傳播學系', degree: '碩士', experience: '茁思科技股份有限公司-專案經理(2025-迄今)\n思維互動有限公司-專案經理(2024)\n傑森全球整合行銷股份有限公司-專案行銷副理(2018-2024)\n思創奇策股份有限公司-行銷企劃(2017-2018)', defaultTitle: '專案經理', skills: '專案管理、協同協調專案開發進度、文件建立收發歸檔、Google Workspace、專案管理工具、Microsoft Office、Adobe。', selectedProjectIds: [] },
            { id: 'p5', name: '徐致偉', gender: '男', currentJob: '茁思科技資深工程師', school: '中國科技大學', department: '資訊管理系', degree: '學士', experience: '茁思科技股份有限公司-資深工程師 (2023-迄今)\n科盛科技股份有限公司-資深工程師 (2017-2023)\n映通股份有限公司-工程師 (2007-2017)', defaultTitle: '技術主管', skills: '#Unity3D #C# #Blender #Illustrator #Photoshop #Premiere Pro', selectedProjectIds: [] },
            { id: 'p6', name: '張惟翔', gender: '男', currentJob: '茁思科技全端工程師', school: 'Sheridan College', department: 'Systems Technician - Software Engineering', degree: '碩士', experience: 'OrangePos IT Supervisor\nPointClickCare Software Engineer\nReno Lighting IT technician\nAlteam Project Manager', defaultTitle: '系統工程師', skills: '(尚無資料，請手動輸入)', selectedProjectIds: [] },
            { id: 'p7', name: '阮紹倫', gender: '男', currentJob: '茁思科技軟體工程師', school: '龍華科技大學', department: '文化創意與設計學系', degree: '學士', experience: '茁思科技股份有限公司(2025-迄今)\n慈濟學校財團法人慈濟大學研究助理(2024)\n旺捷智能感知股份有限公司軟體工程師(2022~2024)\n龍華科技大學兼任助理(2019~2021)', defaultTitle: '軟體工程師', skills: 'AR、VR、Unity、C#、Illustrator、Photoshop、AfterEffect、Excel、PowerPoint、Word', selectedProjectIds: [] },
            { id: 'p8', name: '朱家宜', gender: '女', currentJob: '茁思科技遊戲企劃', school: '倫敦藝術大學', department: '遊戲設計研究所', degree: '碩士', experience: '茁思科技股份有限公司 遊戲企劃(2025-迄今)\n致樂創意股份有限公司 遊戲設計師 (專案合作) (2022-2023)\n暴風數位股份有限公司 策展實習生(2021)\n雷亞遊戲股份有限公司 遊戲測試實習生(2020)', defaultTitle: '互動企劃師', skills: '遊戲企劃、遊戲編劇、專案溝通/整合管理、Google workspace、PowerPoint、Word、Canvas、Adobe Premiere Pro、Adobe Photoshop、Aseprite', selectedProjectIds: [] },
            { id: 'p9', name: '陳佳芸', gender: '女', currentJob: '茁思科技 美術暨 UIUX 設計師', school: '大同大學', department: '媒體設計學系 - 互動組', degree: '學士', experience: '茁思科技股份有限公司-美術暨 UIUX 設計師(2025-迄今)\nJubo 智齡科技-產品研發部 UX intern (2024)', defaultTitle: 'UIUX 設計師', skills: 'UI / UX、介面設計、使用者研究調查、平面設計、icon 設計、Figma 原型、Adobe', selectedProjectIds: [] },
            { id: 'p10', name: '陳奕彣', gender: '女', currentJob: '茁思科技專案經理', school: '國立臺北大學', department: '民俗藝術與文化資產研究所', degree: '碩士', experience: '茁思科技專案經理(2021/4~迄今)\n國立傳統藝術中心 (臺灣戲曲中心) 專案企劃(2018/5~2021/4)', defaultTitle: '專案經理', skills: '標案採購、執行編輯、專案管理', selectedProjectIds: [] },
            { id: 'p11', name: '廖婉如', gender: '女', currentJob: '茁思科技專案經理', school: '國立臺灣大學', department: '食品安全與健康研究所', degree: '碩士', experience: '茁思科技股份有限公司專案經理(2025-迄今)\n競禾實業股份有限公司品牌營養師(2022-2023)\n長春藤預防醫學診所營養師(2021-2022)', defaultTitle: '協同專案經理', skills: '專案管理、Word、PowerPoint、Canva', selectedProjectIds: [] },
            { id: 'p12', name: '黃芊穎', gender: '女', currentJob: '茁思科技專案經理', school: '南台科技大學', department: '財務金融系', degree: '學士', experience: '茁思科技股份有限公司專案經理（2025-迄今）\n衣騰科技股份有限公司 專案經理（2019-2022）', defaultTitle: '專案經理', skills: '專案管理、Excel、PowerPoint、Word、計劃管理、規劃執行、計畫管理工具、資料蒐集與統整、市場分析、客戶關係管理、業務推廣執行、合約管理與履約監督、內部協調與報告、維護客戶關係、參與推廣活動、協商合約條款、其他部門協調以支持業務運作', selectedProjectIds: [] },
            { id: 'p13', name: '林韋良', gender: '男', currentJob: '茁思科技業務專員', school: '銘傳大學', department: '企業管理學系', degree: '學士', experience: '茁思科技股份有限公司業務人員 (2025~迄今)\n巨匠電腦股份有限公司 店經理 (2018~2025)\n巨匠電腦股份有限公司 活動企劃 (2017~2018)', defaultTitle: '客戶服務專員', skills: '客戶開發與關係經營、需求訪談與應用規劃、解決方案式銷售、專案執行與進度協調、活動與推廣企劃、門市營運管理、跨部門溝通協作、簡報提案製作、使用者體驗流程規劃、Google Workspace、Excel、PowerPoint、Visio、Adobe', selectedProjectIds: [] }
        ];

        window.INITIAL_PROJECTS_DATA = [
            { id: 3, name: '114 年度機車產業輔導轉型執行委託專業服務計畫', client: '基隆市政府產業發展處', endDate: '2025/12' },
            { id: 1, name: '114 年度新北市政府水土保持戶外教學及多元化宣導計畫', client: '新北市政府農業局', endDate: '2025/12' },
            { id: 2, name: '113-114 年淨零綠生活教育推廣專案工作計畫', client: '環境部', endDate: '2025/11' },
            { id: 4, name: '2026 國際少年運動會及世界俱樂部龍舟錦標賽 360VR 體育場景雙語互動式導覽建置採購案', client: '花蓮縣秀林鄉水源國民小學', endDate: '2025/10' },
            { id: 5, name: '114 年擴充虛擬實境應變模擬訓練單元', client: '國家原子能科技研究院', endDate: '2025/7' },
            { id: 6, name: '113 年水保酷學堂功能擴充及整合水保虛擬世界平臺營運計畫', client: '農業部農村水保署', endDate: '2025' },
            { id: 7, name: '113 年新北市政府水土保持戶外教學及多元化宣導計畫', client: '新北市政府農業局', endDate: '2024/12' },
            { id: 8, name: '113 年運動產業平臺功能優化及維護採購案', client: '臺北市政府體育局', endDate: '2024/12' },
            { id: 9, name: '113 年臺大體育室官網弱掃修復', client: '臺灣大學', endDate: '2024/12' },
            { id: 10, name: '113 年桃園市政府消防局防火宣導系統後續擴充案', client: '桃園市政府消防局', endDate: '2024/12' },
            { id: 11, name: '113 年桃園市政府體育局各國民運動中心履約系統維護案', client: '桃園市政府體育局', endDate: '2024/12' },
            { id: 12, name: '113 年戶外教室互動導覽網頁維護案', client: '水保署花蓮分署', endDate: '2024/12' },
            { id: 13, name: '112 年水保酷學堂平臺營運計畫', client: '農業部農村水保署', endDate: '2023/12' },
            { id: 14, name: '112 年新北市政府水土保持戶外教學及多元化宣導計畫', client: '新北市政府農業局', endDate: '2023/12' },
            { id: 15, name: '112 年水保網絡虛擬體驗計畫', client: '農業部農村水保署', endDate: '2023/12' },
            { id: 16, name: '112 年桃園市政府消防局防火宣導系統建置案', client: '桃園市政府消防局', endDate: '2023/08' },
            { id: 17, name: '桃園市國民運動中心履約管理系統維護案', client: '桃園市政府體育局', endDate: '2023/12' },
            { id: 18, name: '112 年臺中分局水土保持教育宣導推廣計畫', client: '農業部農村水保署臺中分署', endDate: '2023/12' },
            { id: 19, name: '111 年寶山鄉橄欖產業創生事業計畫', client: '新竹縣寶山鄉公所', endDate: '2023/06' },
            { id: 20, name: '111 年臺南市交通局教育宣導', client: '臺南市交通局', endDate: '2023/03' },
            { id: 21, name: '111 年度本局轄管運動場館(地)租借系統功能擴充委外建置資訊服務勞務採購案', client: '臺北市政府體育局', endDate: '2023/02' },
            { id: 22, name: '111 年運動產業服務平臺功能新增及優化採購案', client: '臺北市政府體育局', endDate: '2023/01' },
            { id: 23, name: '110 年度捕蜂捉蛇為民服務資訊管理整合平臺採購案', client: '臺中市政府農業局', endDate: '2022/09' },
            { id: 24, name: '戶外體驗活動運動平臺功能擴充', client: '臺北市政府產業科', endDate: '2023/01' },
            { id: 25, name: '111 年戶外教室互動導覽網頁', client: '行政院農業委員會水土保持局花蓮分局', endDate: '2022/12' },
            { id: 26, name: '111 年臺中分局水土保持宣導推廣無弗界計畫', client: '行政院農業委員會水土保持局臺中分局', endDate: '2022/12' },
            { id: 27, name: '111 年中小企業總會-第二屆 T 大使 Gather 畢業典禮/開訓典禮', client: '中小企業總會', endDate: '2022/03' },
            { id: 28, name: '110 年臺灣大學總務處事務組會議室管理系統維護案', client: '臺灣大學', endDate: '2022/09' },
            { id: 29, name: '110 年度本局轄管運動場館(地)租借系統功能擴充維護委外資訊服務勞務採購案', client: '臺北市政府體育局', endDate: '2022/02' },
            { id: 30, name: '110 年度運動產業管理平臺委託資訊服務案', client: '臺北市政府體育局', endDate: '2021/12' },
            { id: 31, name: '客家委員會客家文化發展中心臺灣客家文化館 360VR 環景攝影', client: '客家委員會客家文化發展中心', endDate: '2017/10' },
            { id: 32, name: '臺北市政府體育局運動場館環景導覽系統案', client: '臺北市政府體育局', endDate: '2017/09' },
            { id: 33, name: '桃園市第二屆花彩節 Google 地標採購案', client: '桃園市政府資訊中心', endDate: '2017/01' },
            { id: 34, name: '私立格致中學校園環景建置案', client: '私立格致中學', endDate: '2016/05' }
        ];

        window.jobTitles = [
            "客戶服務組長",
            "客戶服務專員",
            "計畫主持人",
            "協同計畫主持人",
            "計畫業務組長",
            "專案經理",
            "協同專案經理",
            "技術主管",
            "系統工程師",
            "軟體工程師",
            "互動企劃師",
            "UIUX 設計師"
        ];
    </script>

    <!-- JavaScript & Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State Variables (Client Side)
        let employees = []; // Synced from DB
        let projects = [];  // Synced from DB
        let currentEmpId = '';
        let currentUser = null;
        let db = null;
        let appId = 'default-app-id'; // Will be overwritten by environment
        let debounceTimer = null;

        // Sorting Helper
        function sortProjectsByDate(a, b) {
            const getVal = (dateStr) => {
                if (!dateStr) return 0;
                // Remove non-date chars if any, though data seems clean
                const parts = dateStr.trim().split('/');
                const year = parseInt(parts[0], 10) || 0;
                const month = parseInt(parts[1], 10) || 0;
                return year * 100 + month;
            };
            
            return getVal(b.endDate) - getVal(a.endDate);
        }

        // --- Firebase Initialization ---
        function initFirebase() {
            const firebaseConfig = JSON.parse(__firebase_config || '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);

            // Auth Flow
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };

            initAuth();

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    updateStatus('已連線', 'bg-green-100 text-green-700');
                    setupListeners();
                } else {
                    updateStatus('離線', 'bg-red-100 text-red-700');
                }
            });
        }

        function updateStatus(text, classes) {
            const el = document.getElementById('cloud-status');
            el.textContent = text;
            el.className = `text-xs ml-2 px-2 py-0.5 rounded-full ${classes}`;
        }

        // --- Firestore Listeners ---
        function setupListeners() {
            if (!currentUser) return;

            // 1. Projects Listener (Public Data)
            // Using RULE 1: /artifacts/{appId}/public/data/projects
            const projectsCol = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
            onSnapshot(projectsCol, (snapshot) => {
                if (snapshot.empty && projects.length === 0) {
                     // Initial Seed if empty
                     seedProjects(projectsCol);
                } else {
                    projects = snapshot.docs.map(d => d.data());
                    // Sort by Date Descending
                    projects.sort(sortProjectsByDate);
                    window.projects = projects; // Expose for non-module functions
                    renderMasterProjectList();
                    // If we are on edit screen, update list
                    if (currentEmpId) renderProjectSelectionList(); 
                }
            }, (error) => console.error("Projects sync error:", error));

            // 2. Employees Listener (Public Data for Sharing)
            const employeesCol = collection(db, 'artifacts', appId, 'public', 'data', 'employees');
            onSnapshot(employeesCol, (snapshot) => {
                if (snapshot.empty && employees.length === 0) {
                    seedEmployees(employeesCol);
                } else {
                    employees = snapshot.docs.map(d => d.data());
                    // Sort employees by ID p1, p2...
                    employees.sort((a, b) => parseInt(a.id.replace('p','')) - parseInt(b.id.replace('p','')));
                    window.employees = employees; // Expose
                    
                    // Update Dropdown options
                    updateEmployeeSelect();
                    
                    // If currently editing someone, refresh their data (careful not to break typing)
                    if (currentEmpId) {
                        const latestData = employees.find(e => e.id === currentEmpId);
                        if (latestData) {
                            if(document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                                loadEmployeeDataToForm(latestData);
                            }
                            // ALWAYS update the selection list (checkboxes don't interfere with typing)
                            renderProjectSelectionList();
                        }
                    }
                }
            }, (error) => console.error("Employees sync error:", error));
        }

        // --- Seeding Data ---
        async function seedProjects(colRef) {
            const batch = writeBatch(db);
            window.INITIAL_PROJECTS_DATA.forEach(p => {
                // Use ID as doc ID for simplicity
                const docRef = doc(colRef, p.id.toString());
                batch.set(docRef, p);
            });
            await batch.commit();
            console.log("Seeded Projects");
        }

        async function seedEmployees(colRef) {
            const batch = writeBatch(db);
            window.INITIAL_EMPLOYEES_DATA.forEach(e => {
                const docRef = doc(colRef, e.id);
                batch.set(docRef, e);
            });
            await batch.commit();
            console.log("Seeded Employees");
        }

        // --- Business Logic exposed to Window ---
        
        window.switchEmployee = (empId) => {
            currentEmpId = empId;
            if(!empId) return;
            const emp = employees.find(e => e.id === empId);
            if(emp) loadEmployeeDataToForm(emp);
            renderProjectSelectionList();
        };

        window.loadEmployeeDataToForm = (emp) => {
            document.getElementById('input-name').value = emp.name;
            document.getElementById('input-gender').value = emp.gender;
            document.getElementById('input-currentJob').value = emp.currentJob;
            document.getElementById('input-school').value = emp.school;
            document.getElementById('input-department').value = emp.department;
            document.getElementById('input-degree').value = emp.degree;
            document.getElementById('input-experience').value = emp.experience;
            document.getElementById('input-skills').value = emp.skills;
            document.getElementById('input-defaultTitle').value = emp.defaultTitle || "";
            document.getElementById('selected-count').textContent = (emp.selectedProjectIds || []).length;
        };

        // --- Update Logic (Writes to DB) ---

        // Generic update function for employee fields
        window.updateCurrentEmployee = async (field, value) => {
            if (!currentEmpId || !currentUser) return;
            
            showSaving();
            const empDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'employees', currentEmpId);
            await updateDoc(empDocRef, {
                [field]: value
            });
            showSaved();
        };

        // Debounced update for text inputs
        window.debounceUpdate = (field, value) => {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateCurrentEmployee(field, value);
            }, 500); // 500ms delay
        };

        window.updateSkillsFromSelect = (value) => {
            if(value) {
                document.getElementById('input-skills').value = value;
                updateCurrentEmployee('skills', value);
            }
        };

        window.toggleProjectSelection = async (projectId, checkbox) => {
            if (!currentEmpId) return;
            const emp = employees.find(e => e.id === currentEmpId);
            if (!emp) return;

            let newIds = [...(emp.selectedProjectIds || [])];
            if (checkbox.checked) {
                if (!newIds.includes(projectId)) newIds.push(projectId);
            } else {
                newIds = newIds.filter(id => id !== projectId);
            }

            // Optimistic UI update
            const label = checkbox.closest('label');
            if (checkbox.checked) {
                label.classList.remove('hover:bg-gray-50', 'border-gray-100');
                label.classList.add('bg-green-50', 'border-green-200');
            } else {
                label.classList.remove('bg-green-50', 'border-green-200');
                label.classList.add('hover:bg-gray-50', 'border-gray-100');
            }

            showSaving();
            const empDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'employees', currentEmpId);
            await updateDoc(empDocRef, { selectedProjectIds: newIds });
            showSaved();
        };

        window.toggleSelectAll = async () => {
             if (!currentEmpId) return;
             const emp = employees.find(e => e.id === currentEmpId);
             if (!emp) return;
             
             const allIds = projects.map(p => p.id);
             const currentIds = emp.selectedProjectIds || [];
             const isAllSelected = allIds.every(id => currentIds.includes(id));
             
             let newIds = [];
             if (!isAllSelected) {
                 newIds = [...allIds];
             }

             // OPTIMISTIC UPDATE
             emp.selectedProjectIds = newIds;
             renderProjectSelectionList(); // Re-render the list immediately

             showSaving();
             const empDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'employees', currentEmpId);
             await updateDoc(empDocRef, { selectedProjectIds: newIds });
             showSaved();
        };

        // --- Project Management (Writes to DB) ---
        window.addNewProject = async () => {
            const name = document.getElementById('new-project-name').value;
            const client = document.getElementById('new-project-client').value;
            const date = document.getElementById('new-project-date').value;

            if (!name) { alert('請輸入專案名稱'); return; }

            const newId = projects.length > 0 ? Math.max(...projects.map(p => p.id)) + 1 : 1;

            const newProject = {
                id: newId,
                name: name,
                client: client,
                endDate: date
            };

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'projects', newId.toString());
            await setDoc(docRef, newProject);

            // Clear inputs
            document.getElementById('new-project-name').value = '';
            document.getElementById('new-project-client').value = '';
            document.getElementById('new-project-date').value = '';
        };

        window.deleteProject = async (id) => {
            if (confirm('確定要從系統中刪除此專案嗎？這將會從雲端資料庫永久刪除。')) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'projects', id.toString());
                await deleteDoc(docRef);
            }
        };

        // --- Rendering Helpers ---
        function updateEmployeeSelect() {
            const select = document.getElementById('employee-select');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- 請選擇人員 --</option>';
            employees.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp.id;
                opt.textContent = `${emp.name} (${emp.currentJob})`;
                select.appendChild(opt);
            });
            if (currentVal && employees.find(e => e.id === currentVal)) {
                select.value = currentVal;
            }
        }

        window.renderProjectSelectionList = () => {
            const container = document.getElementById('project-selection-list');
            container.innerHTML = '';
            
            if (!currentEmpId) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">請先選擇左側人員</div>';
                return;
            }

            const emp = employees.find(e => e.id === currentEmpId);
            const selectedIds = emp ? (emp.selectedProjectIds || []) : [];

            document.getElementById('selected-count').textContent = selectedIds.length;

            projects.forEach(project => {
                const isChecked = selectedIds.includes(project.id);
                const label = document.createElement('label');
                label.className = `flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all ${isChecked ? 'bg-green-50 border-green-200' : 'hover:bg-gray-50 border-gray-100'}`;
                label.innerHTML = `
                    <div class="mt-1">
                        <input type="checkbox" onchange="toggleProjectSelection(${project.id}, this)" ${isChecked ? 'checked' : ''} class="w-5 h-5 text-green-600 rounded focus:ring-green-500 border-gray-300 accent-green-600">
                    </div>
                    <div>
                        <div class="font-medium text-gray-900 text-sm leading-snug">${project.name}</div>
                        <div class="text-xs text-gray-500 mt-1 flex justify-between gap-4">
                            <span>${project.client}</span>
                            <span>${project.endDate}</span>
                        </div>
                    </div>
                `;
                container.appendChild(label);
            });
        };

        window.renderMasterProjectList = () => {
            const container = document.getElementById('master-project-list');
            document.getElementById('total-projects-count').textContent = projects.length;
            container.innerHTML = '';

            projects.forEach(project => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4">${project.name}</td>
                    <td class="px-6 py-4 text-gray-600">${project.client}</td>
                    <td class="px-6 py-4 text-gray-600">${project.endDate}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteProject(${project.id})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors">
                            <i data-lucide="trash-2" width="16"></i>
                        </button>
                    </td>
                `;
                container.appendChild(tr);
            });
            lucide.createIcons();
        };

        // --- UI Utils ---
        function showSaving() {
            const ind = document.getElementById('save-indicator');
            ind.innerHTML = '<i data-lucide="loader-2" class="animate-spin" width="12"></i> 儲存中...';
            ind.className = 'absolute top-4 right-4 text-xs font-bold text-blue-600 opacity-100 transition-opacity flex items-center gap-1';
            lucide.createIcons();
        }

        function showSaved() {
            setTimeout(() => {
                const ind = document.getElementById('save-indicator');
                ind.innerHTML = '<i data-lucide="check" width="12"></i> 已儲存';
                ind.className = 'absolute top-4 right-4 text-xs font-bold text-green-600 opacity-100 transition-opacity flex items-center gap-1';
                lucide.createIcons();
                setTimeout(() => {
                    ind.classList.add('opacity-0');
                    ind.classList.remove('opacity-100');
                }, 2000);
            }, 500);
        }

        // --- 8. 初始化下拉選單 (Static Options) ---
        function initSelectOptions() {
            // Titles - Using window.jobTitles
            const titleSelect = document.getElementById('input-defaultTitle');
            if (window.jobTitles) {
                window.jobTitles.forEach(title => {
                    const opt = document.createElement('option');
                    opt.value = title;
                    opt.textContent = title;
                    titleSelect.appendChild(opt);
                });
            }

            // Skills
            const skillSelect = document.getElementById('skills-select');
            if (window.INITIAL_EMPLOYEES_DATA) {
                window.INITIAL_EMPLOYEES_DATA.forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = emp.skills;
                    let shortSkill = emp.skills.substring(0, 20) + (emp.skills.length > 20 ? '...' : '');
                    if (!shortSkill) shortSkill = "(空白)";
                    opt.textContent = `${emp.name} 的專長組合: ${shortSkill}`;
                    skillSelect.appendChild(opt);
                });
            }
        }

        // --- Start App ---
        initFirebase();
        
        // ** FIX 1: Explicitly call initSelectOptions at the end of module execution **
        initSelectOptions();
        
        // ** FIX 3: Explicitly call createIcons for static elements on startup **
        lucide.createIcons();

        // --- Tab Switching Logic (Legacy) ---
        window.switchTab = (tabId) => {
            ['edit', 'projects', 'preview'].forEach(id => {
                document.getElementById(`${id}-section`).classList.add('hidden');
                document.getElementById(`btn-${id}`).classList.remove('bg-blue-100', 'text-blue-700', 'font-medium');
                document.getElementById(`btn-${id}`).classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            document.getElementById(`${tabId}-section`).classList.remove('hidden');
            const activeBtn = document.getElementById(`btn-${tabId}`);
            activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
            activeBtn.classList.add('bg-blue-100', 'text-blue-700', 'font-medium');
            if (tabId === 'preview') renderPreview();
        };

        // --- Preview Logic ---
        window.renderPreview = () => {
             const warningEl = document.getElementById('preview-warning');
             const contentEl = document.getElementById('preview-content-container');

             if (!currentEmpId) {
                warningEl.classList.remove('hidden');
                contentEl.classList.add('hidden');
                return;
            }
            
            warningEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

            const emp = employees.find(e => e.id === currentEmpId);
            if (!emp) return;

            document.getElementById('preview-headerTitle').textContent = emp.defaultTitle || "職稱";
            document.getElementById('preview-name').textContent = emp.name;
            document.getElementById('preview-gender').textContent = emp.gender;
            document.getElementById('preview-currentJob').textContent = emp.currentJob;
            document.getElementById('preview-school').textContent = emp.school;
            document.getElementById('preview-department').textContent = emp.department;
            document.getElementById('preview-degree').textContent = emp.degree;
            document.getElementById('preview-experience').innerHTML = (emp.experience || "").replace(/\n/g, "<br>");
            document.getElementById('preview-skills').textContent = emp.skills;

            const container = document.getElementById('preview-project-list');
            container.innerHTML = '';
            
            const selectedIds = emp.selectedProjectIds || [];
            // FIX 2: Sort selected projects by Date Descending
            const selectedProjects = projects
                                    .filter(p => selectedIds.includes(p.id))
                                    .sort(sortProjectsByDate);

            if (selectedProjects.length === 0) {
                container.innerHTML = '<div class="p-8 text-center font-serif text-gray-400 border-b border-black">(尚無參與專案資料)</div>';
            } else {
                selectedProjects.forEach(project => {
                    const row = document.createElement('div');
                    row.className = 'flex border-b border-black min-h-[50px]';
                    row.innerHTML = `
                        <div class="w-[60%] px-2 py-2 border-r border-black font-serif text-lg flex items-center">${project.name}</div>
                        <div class="w-[25%] px-2 py-2 border-r border-black font-serif text-lg flex items-center">${project.client}</div>
                        <div class="w-[15%] px-2 py-2 font-serif text-lg flex items-center">${project.endDate}</div>
                    `;
                    container.appendChild(row);
                });
            }
        };

         window.downloadWord = () => {
            if (!currentEmpId) { alert("請先選擇人員"); return; }
            const emp = employees.find(e => e.id === currentEmpId);
            const selectedIds = emp.selectedProjectIds || [];
            // FIX 2: Sort selected projects by Date Descending
            const selectedProjects = projects
                                    .filter(p => selectedIds.includes(p.id))
                                    .sort(sortProjectsByDate);

            let projectsRows = '';
            if (selectedProjects.length === 0) {
                projectsRows = `<tr><td colspan="3" style="text-align:center;color:#888;">(尚無參與專案資料)</td></tr>`;
            } else {
                selectedProjects.forEach(p => {
                    projectsRows += `
                        <tr>
                            <td width="60%">${p.name}</td>
                            <td width="25%">${p.client}</td>
                            <td width="15%">${p.endDate}</td>
                        </tr>
                    `;
                });
            }

            const experienceHtml = (emp.experience || "").replace(/\n/g, "<br>");
            const wordHTML = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <title>Resume</title>
                    <style>
                        body { font-family: "標楷體", "DFKai-SB", "BiauKai", "MingLiU", serif; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: -1px; }
                        td { border: 1px solid black; padding: 6px; font-size: 12pt; vertical-align: middle; }
                        .header-row { background-color: #6495ED; color: black; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <table><tr class="header-row"><td colspan="2">${emp.defaultTitle || '職稱'}</td></tr></table>
                    <table><tr><td width="50%">姓名：${emp.name}</td><td width="50%">性別：${emp.gender}</td></tr></table>
                    <table><tr><td width="100%">現職：${emp.currentJob}</td></tr></table>
                    <table><tr class="header-row"><td width="100%">最高學歷</td></tr></table>
                    <table><tr class="header-row"><td width="33%">學校名稱</td><td width="33%">系所</td><td width="33%">學位</td></tr><tr><td>${emp.school}</td><td>${emp.department}</td><td>${emp.degree}</td></tr></table>
                    <table><tr class="header-row"><td width="100%">經歷</td></tr></table>
                    <table><tr><td width="100%">${experienceHtml}</td></tr></table>
                    <table><tr class="header-row"><td width="100%">專長</td></tr></table>
                    <table><tr><td width="100%">${emp.skills}</td></tr></table>
                    <table><tr class="header-row"><td width="60%">參與專案活動名稱</td><td width="25%">客戶</td><td width="15%">結案日期</td></tr></table>
                    <table>${projectsRows}</table>
                </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', wordHTML], { type: 'application/msword' });
            const href = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = href;
            link.download = `${emp.name}_履歷.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(href);
        };
    </script>
</body>
</html>